# FreeMarker Fragments for Spring Boot MVC

The code below is a Spring Boot config file where all that is required is its inclusion in order to add
fragment support to MVC for FreeMarker.

### Details

A fragment can be renderer in a Controller by including a fragment identifier as part of the view name,  
e.g. `return "myView :: my-fragment";`  
Including the fragment identifier will cause the matching macro in that template to be invoked and the output
generated by that macro will be rendered, without anything special having to be done in the template.

Optionally, the code can automatically convert kebab-case and snake_case identifiers to match macros with
UpperCamelCase (PascalCase) names e.g. using `view :: my-fragment` to invoke the macro `MyFragment`. This is
disabled by default.


```java
package com.example.demo;

import java.io.IOException;
import java.io.StringReader;
import java.util.Locale;
import java.util.regex.Pattern;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import javax.servlet.http.HttpServletResponse;

import org.springframework.boot.autoconfigure.freemarker.FreeMarkerProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.View;
import org.springframework.web.servlet.view.AbstractUrlBasedView;
import org.springframework.web.servlet.view.freemarker.FreeMarkerView;
import org.springframework.web.servlet.view.freemarker.FreeMarkerViewResolver;

import freemarker.template.SimpleHash;
import freemarker.template.Template;
import freemarker.template.TemplateException;

@Configuration
public class FreeMarkerConfig {

    private static final String FRAGMENT_SEPARATOR = " :: ";
    private static final boolean TRANSLATE_MACRO_NAME = false;

    @Bean
    FreeMarkerViewResolver freeMarkerViewResolver(FreeMarkerProperties properties) {
        FreeMarkerViewResolver resolver = new CustomFreeMarkerViewResolver();
        properties.applyToMvcViewResolver(resolver);
        return resolver;
    }

    static class CustomFreeMarkerView extends FreeMarkerView {
        private static final Pattern ESCAPE_CHARS = Pattern.compile("[-.@]");
        private static final String NAMESPACE = "$__auto_invoke__$";
        String fragmentId;
        String fragmentViewName;

        @Override
        protected void processTemplate(Template template, SimpleHash model, HttpServletResponse response)
                throws IOException, TemplateException {
            if (fragmentId != null) {
                String macro = ESCAPE_CHARS.matcher(toMacroName(fragmentId)).replaceAll("\\\\$0");
                String templateText =
                        "<#import \"/" + template.getName() + "\" as " + NAMESPACE + ">" +
                        "<@" + NAMESPACE + "." + macro + " />";

                template = new Template(
                        fragmentViewName, null,
                        new StringReader(templateText),
                        template.getConfiguration(),
                        template.getParserConfiguration(),
                        template.getEncoding());
            }
            super.processTemplate(template, model, response);
        }

        // e.g. "my-fragment" to "MyFragment"
        private static String toMacroName(String fragmentId) {
            if (TRANSLATE_MACRO_NAME) {
                return Stream.of(fragmentId.split("[-_]"))
                        .map(s -> Character.toUpperCase(s.charAt(0)) + s.substring(1))
                        .collect(Collectors.joining());
            }
            return fragmentId;
        }
    }


    static class CustomFreeMarkerViewResolver extends FreeMarkerViewResolver {
        @Override
        protected View loadView(String viewName, Locale locale) throws Exception {
            String fragmentId = null;
            String originalViewName = viewName;
            int index = viewName.indexOf(FRAGMENT_SEPARATOR);
            if (index != -1) {
                fragmentId = viewName.substring(index + FRAGMENT_SEPARATOR.length());
                viewName = viewName.substring(0, index);
            }

            View view = super.loadView(viewName, locale);
            if (view instanceof CustomFreeMarkerView) {
                ((CustomFreeMarkerView)view).fragmentId = fragmentId;
                ((CustomFreeMarkerView)view).fragmentViewName = originalViewName;
            }
            return view;
        }

        @Override
        protected Class<?> requiredViewClass() {
            return CustomFreeMarkerView.class;
        }
        @Override
        protected AbstractUrlBasedView instantiateView() {
            return getViewClass() == CustomFreeMarkerView.class
                    ? new CustomFreeMarkerView() : super.instantiateView();
        }
    }

}
```